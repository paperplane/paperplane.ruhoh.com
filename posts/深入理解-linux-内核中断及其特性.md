---
title:
date: '2012-09-26'
description:
categories: Linux
tags: ['linux内核']
---
##摘要##
    
  本文对中断系统进行详细的剖析,主要内容包括中断与异常、中断实现、中断控制器、中断上下文、中断亲和力和中断线程化等。   首先简单介绍 Linux 内核中断常用概念及其本质,然后对中断实现基本原理进行简要分析,接着详细探讨了中断亲和力的实现原理,最后对中断线程化背景及工作原理进行介绍。 
    
  *关键字: 中断,中断控制器,中断上下文,中断亲和力,中断线程化*
        
- - -
##什么是中断##
    
对于中断的理解我们先看一个生活中常见的例子:QQ。第一种情况:你正在工作,然后你的好友突然给你发送了一个窗口抖动,打断你正在进行的工作。第二种情况:当然你有时候也会每隔 5 分钟就去检查一下 QQ 看有没有好友找你,虽然这很浪费你的时间。在这里,一次窗口抖动就可以被相当于硬件的中断,而你就相当于 CPU,你的工作就是 CPU 这在执行的进程。而定时查询就被相当于 CPU 的轮询。在这里可以看到:同样作为 CPU 和硬件沟通的方式,中断是硬件主动的方式,较轮询(CPU 主动)更有效些,因为我们都不可能一直无聊到每隔几分钟就去查一遍好友列表。

CPU 有大量的工作需要处理,更不会做这些大量无用功。当然这只是一般情况下。好了,这里又有了一个问题,每个硬件设备都中断,那么如何区分不同硬件呢?不同设备同时中断如何知道哪个中断是来自硬盘、哪个来自网卡呢?这个很容易,不是每个 QQ 号码都不相同吗?同样的,系统上的每个硬件设备都会被分配一个 IRQ 号,通过这个唯一的 IRQ 号就能区别张三和李四了。

中断的本质是一种电信号(物理学),由硬件产生,并直接送往中断控制器的输入引脚中—中断控制器是一个简单的电子芯片。当接收到一个中断后,中断控制器会给处理器发送一个电信号。处理器一经检测到此信号,便中断自己当前工作转而处理中断。此后,处理器会通知操作系统已经产生中断,这样,操作系统就可以对这个中断进行适当的处理。接下来,我们通过几组概念来了解中断的基本概貌。

###中断与异常###

在操作系统中,讨论中断就不能不提及异常。异常与中断不同,它在产生时必须考虑处理器同步。

关于异常与中断的区别,总结有一句话:中断时由硬件产生的异步中断,而异常则是处理器产生的同步中断。所谓同步是指只有在一条指令执行完毕后 CPU 才会发出中断,而不是发生在代码指令执行期间,比如系统调用。而异步就是中断能够在指令之间发生。它们之间处理方式类似。

<table class="table table-bordered table-striped table-condensed">
<tr>
  <td>类别</td> 
  <td>原因</td>
  <td>异步/同步</td>
  <td>返回行为</td>
<tr/>

<tr> 
  <td>中断</td>
  <td>来自IO设备的信号</td>
  <td>异步</td>
  <td>总是返回到下一条指令</td>
<tr/>

<tr>
   <td>陷阱</td>
   <td>有意的异常</td>
   <td>同步</td>
   <td>总是返回到下一条指令</td>
<tr/>

<tr> 
  <td>故障</td>
  <td>潜在可恢复的错误</td>
  <td>同步</td> 
  <td>返回当前指令</td>
<tr/>

<tr>
   <td>终止</td>
   <td>不可恢复的错误</td>
   <td>同步</td> 
   <td>不会返回</td>
<tr/>
</table>
###中断上下文与进程上下文###
这些上下文代表着内核活动的范围。每个处理器在任何指定时间点上的活动必然概括为下列三者之一 :
    + 运行于用户空间,执行用户进程
    + 运行于内核空间,执行进程上下文,代表某个特定的进程执行。
    + 运行于内核空间,执行中断上下文,与任何进程无关,处理某个特定中断。

以上所列几乎包括所用情况,即使边边角角的情况也不例外。例如,CPU空闲,内核运行空进程,出于进程上下文,但运行于内核空间。

在进程上下文中可以通过 Current 宏相关联当前进程,进程上下文可以调用调度程序、可以睡眠。

而在中断上下文中,和进程无关、 current 宏无关,不能睡眠、和不能调用会导致睡眠的函数。中断上下文具有较为严格的时间限制,必须迅速而简洁。
###上半部和下半部###

在响应一个特定中断的时候,内核会执行一个函数,该函数叫做中断处理程序。产生中断的每个设备都有一个相应的中断处理程序,它和特定中断相关联我们又想中断处理程序运行得快,又想中断处理程序完成任务多,这两个目标抵触下,我们把中断处理程序切分为上半部和下半部。

上半部包括中断处理程序,一般处于中断上下文,还和特定体系结构相关。执行中断处理程序时,有可能需要禁止本地或全局中断,加上其异步执行特点,我们希望尽力缩短中断处理程序的执行,把一些工作放在以后执行。

在上半部,内核通过对它的异步执行完成对硬件中断的即时响应。快速、异步、简单的机制负责对硬件做出迅速响应并完成那些时间要求很严格的操作。而下半部完成推后执行的工作,执行与中断处理密切相关但中断处理程序本身并不执行的工作;稍后执行,而且执行期间可以响应所有的中断。

一个简单的上下半部分开的例子就是网卡:拷贝网络数据包到内存,然后读取网卡更多数据包一般在上半部执行,以免网卡缓存溢出。而处理和操作数据包的其他工作在下半部执行。下半部只是推后执行,并没有强调多久,只是不是马上立刻。
